From fc0dbcea3cbf5ca6542989d70aa114e0f87b42cc Mon Sep 17 00:00:00 2001
From: julien delnatte <julien.delnatte@gmail.com>
Date: Mon, 7 Jun 2021 23:19:31 +0200
Subject: [PATCH] work on standalone version with one script only

---
 concatStandaloneScripts.txt | 51 +++++++++++++++++++++++++++++++++++++
 package.json                |  3 ++-
 src/standalone.js           |  9 +++++++
 standalone.js               | 38 +++++++++++++--------------
 4 files changed, 81 insertions(+), 20 deletions(-)
 create mode 100644 concatStandaloneScripts.txt
 create mode 100644 src/standalone.js

diff --git a/concatStandaloneScripts.txt b/concatStandaloneScripts.txt
new file mode 100644
index 00000000..1fcf1ddf
--- /dev/null
+++ b/concatStandaloneScripts.txt
@@ -0,0 +1,51 @@
+./src/standalone.js
+./src/kiri.js
+./src/ext/three.js
+./src/ext/pngjs.js
+./src/ext/jszip.js
+./src/license.js
+./src/ext/clip2.js
+./src/ext/earcut.js
+./src/add/array.js
+./src/add/three.js
+./src/add/class.js
+./src/geo/base.js
+./src/geo/debug.js
+./src/geo/point.js
+./src/geo/points.js
+./src/geo/slope.js
+./src/geo/line.js
+./src/geo/bounds.js
+./src/geo/polygon.js
+./src/geo/polygons.js
+./src/geo/gyroid.js
+./src/moto/pack.js
+./src/kiri/conf.js
+./src/kiri/client.js
+./src/kiri/engine.js
+./src/kiri/slice.js
+./src/kiri/slicer.js
+./src/kiri/slicer2.js
+./src/kiri/layers.js
+./src/mode/fdm/fill.js
+./src/mode/fdm/driver.js
+./src/mode/fdm/slice.js
+./src/mode/fdm/prepare.js
+./src/mode/fdm/export.js
+./src/mode/sla/driver.js
+./src/mode/sla/slice.js
+./src/mode/sla/export.js
+./src/mode/cam/driver.js
+./src/mode/cam/ops.js
+./src/mode/cam/tool.js
+./src/mode/cam/topo.js
+./src/mode/cam/slice.js
+./src/mode/cam/prepare.js
+./src/mode/cam/export.js
+./src/mode/cam/animate.js
+./src/mode/laser/driver.js
+./src/kiri/widget.js
+./src/kiri/print.js
+./src/kiri/codec.js
+./src/kiri/worker.js
+./src/moto/load-stl.js
\ No newline at end of file
diff --git a/package.json b/package.json
index ea3648c5..3da22775 100644
--- a/package.json
+++ b/package.json
@@ -9,7 +9,8 @@
         "moveWorkerImport": "sed -i '' 's/\\/code\\/worker.js/.\\/vendors\\/kiri\\/worker.js/g' ./code/engine.js",
         "concatEngine": "xargs cat < ./concatEngineScripts.txt > ./code/engine.js",
         "concatWorker": "xargs cat < ./concatWorkerScripts.txt > ./code/worker.js",
-        "concatFiles": "npm run concatEngine && npm run concatWorker && npm run moveWorkerImport"
+        "concatStandalone": "xargs cat < ./concatStandaloneScripts.txt > ./code/standalone.js",
+        "concatFiles": "npm run concatEngine && npm run concatWorker && npm run moveWorkerImport && npm run concatStandalone"
     },
     "repository": {
         "type": "git",
diff --git a/src/standalone.js b/src/standalone.js
new file mode 100644
index 00000000..c4f52bab
--- /dev/null
+++ b/src/standalone.js
@@ -0,0 +1,9 @@
+navigator = { userAgent: "" };
+self = {
+    THREE,
+    kiri: { driver: {}, loader: [] },
+    location: { hostname: 'local', port: 0, protocol: 'fake' },
+    postMessage: (msg) => {
+        self.kiri.client.onmessage({data:msg});
+    }
+};
\ No newline at end of file
diff --git a/standalone.js b/standalone.js
index 60e13d9b..94aa19c1 100644
--- a/standalone.js
+++ b/standalone.js
@@ -156,7 +156,7 @@ let kiri = self.kiri;
 let moto = self.moto;
 let engine = kiri.newEngine();
 
-fetch('/web/obj/cube.stl').then(data => {
+fetch('/web/obj/cube_kiri.stl').then(data => {
     let buf = data.arrayBuffer().buffer;
     engine.parse(buf)
     .then(data => {
@@ -253,26 +253,26 @@ fetch('/web/obj/cube.stl').then(data => {
         "gcodeTrack":[],
         "gcodeLayer":[],
         "gcodePre":[
-            "M107                     ; turn off filament cooling fan",
-            "G90                      ; set absolute positioning mode",
-            "M82                      ; set absolute positioning for extruder",
-            "M104 S{temp} T{tool}     ; set extruder temperature",
-            "M140 S{bed_temp} T{tool} ; set bed temperature",
-            "G28                      ; home axes",
-            "G92 X0 Y0 Z0 E0          ; reset all axes positions",
-            "G1 X0 Y0 Z0.25 F180      ; move XY to 0,0 and Z 0.25mm over bed",
-            "G92 E0                   ; zero the extruded",
-            "M190 S{bed_temp} T{tool} ; wait for bed to reach target temp",
-            "M109 S{temp} T{tool}     ; wait for extruder to reach target temp",
-            "G92 E0                   ; zero the extruded",
-            "G1 F225                  ; set feed speed"
+        "M107                     ; turn off filament cooling fan",
+        "G90                      ; set absolute positioning mode",
+        "M82                      ; set absolute positioning for extruder",
+        "M104 S{temp} T{tool}     ; set extruder temperature",
+        "M140 S{bed_temp} T{tool} ; set bed temperature",
+        "G28                      ; home axes",
+        "G92 X0 Y0 Z0 E0          ; reset all axes positions",
+        "G1 X0 Y0 Z0.25 F180      ; move XY to 0,0 and Z 0.25mm over bed",
+        "G92 E0                   ; zero the extruded",
+        "M190 S{bed_temp} T{tool} ; wait for bed to reach target temp",
+        "M109 S{temp} T{tool}     ; wait for extruder to reach target temp",
+        "G92 E0                   ; zero the extruded",
+        "G1 F225                  ; set feed speed"
         ],
         "gcodePost":[
-            "M107                     ; turn off filament cooling fan",
-            "M104 S0 T{tool}          ; turn off right extruder",
-            "M140 S0 T{tool}          ; turn off bed",
-            "G1 X0 Y300 F1200         ; end move",
-            "M84                      ; disable stepper motors"
+        "M107                     ; turn off filament cooling fan",
+        "M104 S0 T{tool}          ; turn off right extruder",
+        "M140 S0 T{tool}          ; turn off bed",
+        "G1 X0 Y300 F1200         ; end move",
+        "M84                      ; disable stepper motors"
         ],
         "gcodeProc":"",
         "gcodePause":[],
-- 
2.20.1 (Apple Git-117)

