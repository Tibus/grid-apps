From 4df255874338a48dc65a5cf14eeb28151ec9c495 Mon Sep 17 00:00:00 2001
From: julien delnatte <julien.delnatte@gmail.com>
Date: Tue, 8 Jun 2021 02:36:15 +0200
Subject: [PATCH] fix postMessage

---
 concatStandaloneScripts.txt |  1 -
 src/standalone.js           | 44 +++++++++++++++----------------------
 standaloneLite.js           | 16 ++++++++++----
 3 files changed, 30 insertions(+), 31 deletions(-)

diff --git a/concatStandaloneScripts.txt b/concatStandaloneScripts.txt
index 7cbfb78f..14853153 100644
--- a/concatStandaloneScripts.txt
+++ b/concatStandaloneScripts.txt
@@ -21,7 +21,6 @@
 ./src/moto/pack.js
 ./src/kiri/conf.js
 ./src/kiri/client.js
-./src/kiri/engine.js
 ./src/kiri/slice.js
 ./src/kiri/slicer.js
 ./src/kiri/slicer2.js
diff --git a/src/standalone.js b/src/standalone.js
index 5274f145..4726701b 100644
--- a/src/standalone.js
+++ b/src/standalone.js
@@ -1,27 +1,19 @@
-let navigator = { userAgent: "" };
-let self = global.self = {
-    THREE: global.THREE,
-    kiri : { driver: {}, loader: [] },
-    location : { hostname: 'local', port: 0, protocol: 'fake' },
-    postMessage : (msg) => {
-        self.kiri.client.onmessage({data:msg});
-    }
-};
-
-// fake fetch for worker to get wasm, if needed
-let fetch = function(url) {
-    console.log({fake_fetch: url});
-    let buf = global.fs.readFileSync("./" + url);
-    return new Promise((resolve, reject) => {
-        resolve(new Promise((resolve, reject) => {
-            resolve({
-                arrayBuffer: function() {
-                    return buf;
-                }
-            });
-        }));
-    });
-};
+
+let electron;
+try{
+    electron = require('electron'); 
+}catch(e){}
+
+let fs;
+if (electron?.remote){
+  fs = electron.remote.require("fs");
+}else{
+  fs = require("fs");
+}
+
+self.postMessage = (msg) => {
+    self.kiri.client.onmessage({data:msg});
+}
 
 class Worker {
     constructor(url) {
@@ -29,9 +21,9 @@ class Worker {
     }
 
     postMessage(msg) {
-        setImmediate(() => {
+        // setImmediate(() => {
             self.kiri.worker.onmessage({data:msg});
-        });
+        // });
     }
 
     onmessage(msg) {
diff --git a/standaloneLite.js b/standaloneLite.js
index 43d95f26..dea664c0 100644
--- a/standaloneLite.js
+++ b/standaloneLite.js
@@ -11,12 +11,20 @@ Object.assign(THREE, exports);
 /* only if THREE is not defined */
 /* ---------------------------- */
 
-global.THREE = THREE;
-global.fs = fs;
+let navigator = { userAgent: "" };
+let self = {
+    THREE: THREE,
+    kiri : { driver: {}, loader: [] },
+    location : { hostname: 'local', port: 0, protocol: 'fake' },
+};
 
-require("./code/standalone.js");
+// global.THREE = THREE;
+// global.fs = fs;
 
-let kiri = global.self.kiri;
+eval(fs.readFileSync("./code/standalone.js").toString());
+// require("./code/standalone.js");
+
+let kiri = self.kiri;
 let engine = kiri.newEngine();
 
 
-- 
2.20.1 (Apple Git-117)

